<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ऑफलाइन लर्निंग - राजस्थान डिजिटल एजुकेशन</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .offline-card { border-left: 4px solid #28a745; }
        .online-card { border-left: 4px solid #007bff; }
        .storage-bar { height: 10px; border-radius: 5px; }
        .lecture-item { cursor: pointer; transition: all 0.3s; }
        .lecture-item:hover { background: #f8f9fa; }
        .download-progress { display: none; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="index.html">
            <i class="fas fa-arrow-left me-2"></i>राजस्थान डिजिटल एजुकेशन
        </a>
        <div class="navbar-nav ms-auto">
            <span class="nav-link" id="connection-status">
                <i class="fas fa-wifi text-success"></i> ऑनलाइन
            </span>
        </div>
    </div>
</nav>

<section class="py-4" style="margin-top: 60px;">
    <div class="container">
        <!-- Connection Status & Storage Info -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card offline-card">
                    <div class="card-body">
                        <h5><i class="fas fa-download me-2"></i>ऑफलाइन कंटेंट</h5>
                        <p class="mb-1">डाउनलोड किए गए लेक्चर: <span id="offline-count">0</span></p>
                        <p class="mb-0">कुल साइज़: <span id="offline-size">0 MB</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card online-card">
                    <div class="card-body">
                        <h5><i class="fas fa-cloud me-2"></i>स्टोरेज स्थिति</h5>
                        <div class="storage-bar bg-light mb-2">
                            <div class="bg-primary h-100" id="storage-used" style="width: 0%"></div>
                        </div>
                        <p class="mb-0"><span id="storage-info">लोड हो रहा है...</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Auto-Download Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-cog me-2"></i>ऑटो-डाउनलोड सेटिंग्स</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="auto-download" checked>
                            <label class="form-check-label" for="auto-download">
                                मिस्ड क्लासेस ऑटो-डाउनलोड करें
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="wifi-only" checked>
                            <label class="form-check-label" for="wifi-only">
                                केवल WiFi पर डाउनलोड करें
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <label class="form-label">वीडियो क्वालिटी (डेटा बचाने के लिए)</label>
                    <select class="form-select" id="video-quality">
                        <option value="low">कम (5-10 MB) - Jio Phone के लिए</option>
                        <option value="medium" selected>मध्यम (15-25 MB)</option>
                        <option value="high">उच्च (30-50 MB)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Available for Download -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-cloud-download-alt me-2"></i>डाउनलोड के लिए उपलब्ध</h5>
                <button class="btn btn-sm btn-primary" onclick="refreshAvailableContent()">
                    <i class="fas fa-refresh"></i> रिफ्रेश
                </button>
            </div>
            <div class="card-body">
                <div id="available-content">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">कंटेंट लोड हो रहा है...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Downloaded Content -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-mobile-alt me-2"></i>डाउनलोड किया गया कंटेंट</h5>
                <button class="btn btn-sm btn-danger" onclick="cleanOldContent()">
                    <i class="fas fa-trash"></i> पुराना कंटेंट साफ़ करें
                </button>
            </div>
            <div class="card-body">
                <div id="downloaded-content">
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-download fa-3x mb-3"></i>
                        <p>कोई ऑफलाइन कंटेंट नहीं मिला</p>
                        <p>ऊपर से लेक्चर डाउनलोड करें</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Download Progress Modal -->
<div class="modal fade" id="downloadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">डाउनलोड हो रहा है...</h5>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span id="download-title">लेक्चर डाउनलोड हो रहा है</span>
                        <span id="download-percent">0%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" id="download-progress" style="width: 0%"></div>
                    </div>
                </div>
                <p class="text-muted mb-0">कृपया इंतज़ार करें, यह कुछ मिनट ले सकता है...</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/offline-sync.js"></script>
<script>
// Offline Learning Page Controller
class OfflineLearningPage {
    constructor() {
        this.init();
    }

    async init() {
        await this.updateConnectionStatus();
        await this.updateStorageInfo();
        await this.loadAvailableContent();
        await this.loadDownloadedContent();
        this.setupEventListeners();
        
        // Update every 30 seconds
        setInterval(() => {
            this.updateConnectionStatus();
            this.updateStorageInfo();
        }, 30000);
    }

    setupEventListeners() {
        // Connection status updates
        window.addEventListener('online', () => this.updateConnectionStatus());
        window.addEventListener('offline', () => this.updateConnectionStatus());
        
        // Auto-download settings
        document.getElementById('auto-download').addEventListener('change', (e) => {
            localStorage.setItem('autoDownload', e.target.checked);
        });
        
        document.getElementById('wifi-only').addEventListener('change', (e) => {
            localStorage.setItem('wifiOnly', e.target.checked);
        });
        
        document.getElementById('video-quality').addEventListener('change', (e) => {
            localStorage.setItem('videoQuality', e.target.value);
        });
    }

    updateConnectionStatus() {
        const statusEl = document.getElementById('connection-status');
        if (navigator.onLine) {
            statusEl.innerHTML = '<i class="fas fa-wifi text-success"></i> ऑनलाइन';
        } else {
            statusEl.innerHTML = '<i class="fas fa-wifi-slash text-danger"></i> ऑफलाइन';
        }
    }

    async updateStorageInfo() {
        try {
            const usage = await offlineSync.getStorageUsage();
            if (usage) {
                const usedPercent = (usage.used / usage.available) * 100;
                document.getElementById('storage-used').style.width = usedPercent + '%';
                document.getElementById('storage-info').textContent = 
                    `${usage.usedMB} MB / ${usage.availableMB} MB उपयोग`;
            }
            
            // Update offline content stats
            const lectures = await offlineSync.getOfflineLectures();
            document.getElementById('offline-count').textContent = lectures.length;
            
            const totalSize = lectures.reduce((sum, lecture) => sum + (lecture.size || 0), 0);
            document.getElementById('offline-size').textContent = Math.round(totalSize / 1024 / 1024) + ' MB';
            
        } catch (error) {
            console.error('Error updating storage info:', error);
        }
    }

    async loadAvailableContent() {
        const container = document.getElementById('available-content');
        
        if (!navigator.onLine) {
            container.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-wifi-slash fa-3x mb-3"></i>
                    <p>नया कंटेंट देखने के लिए इंटरनेट कनेक्शन चाहिए</p>
                </div>
            `;
            return;
        }

        try {
            // Mock data - replace with actual API call
            const availableContent = [
                {
                    id: 'lec001',
                    title: 'कंप्यूटर साइंस - डेटा स्ट्रक्चर्स',
                    course: 'B.Tech CSE',
                    duration: '45 मिनट',
                    size: '15 MB',
                    date: '2024-01-15'
                },
                {
                    id: 'lec002', 
                    title: 'गणित - कैलकुलस बेसिक्स',
                    course: 'B.Sc Math',
                    duration: '50 मिनट',
                    size: '18 MB',
                    date: '2024-01-14'
                },
                {
                    id: 'lec003',
                    title: 'कृषि विज्ञान - फसल प्रबंधन',
                    course: 'B.Sc Agriculture',
                    duration: '40 मिनट',
                    size: '12 MB',
                    date: '2024-01-13'
                }
            ];

            container.innerHTML = availableContent.map(content => `
                <div class="lecture-item border rounded p-3 mb-2" onclick="downloadLecture('${content.id}')">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${content.title}</h6>
                            <p class="text-muted mb-1">${content.course} • ${content.duration}</p>
                            <small class="text-muted">${content.date}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-info">${content.size}</span>
                            <br>
                            <button class="btn btn-sm btn-success mt-1">
                                <i class="fas fa-download"></i> डाउनलोड
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

        } catch (error) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    कंटेंट लोड करने में त्रुटि: ${error.message}
                </div>
            `;
        }
    }

    async loadDownloadedContent() {
        const container = document.getElementById('downloaded-content');
        
        try {
            const lectures = await offlineSync.getOfflineLectures();
            
            if (lectures.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-download fa-3x mb-3"></i>
                        <p>कोई ऑफलाइन कंटेंट नहीं मिला</p>
                        <p>ऊपर से लेक्चर डाउनलोड करें</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = lectures.map(lecture => `
                <div class="lecture-item border rounded p-3 mb-2" onclick="playOfflineLecture('${lecture.id}')">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                ${lecture.title}
                                ${lecture.watched ? '<i class="fas fa-check-circle text-success ms-1"></i>' : ''}
                            </h6>
                            <p class="text-muted mb-1">अवधि: ${lecture.duration}</p>
                            <small class="text-muted">डाउनलोड: ${new Date(lecture.downloadDate).toLocaleDateString('hi-IN')}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-secondary">${Math.round(lecture.size / 1024 / 1024)} MB</span>
                            <br>
                            <button class="btn btn-sm btn-primary mt-1">
                                <i class="fas fa-play"></i> प्ले करें
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

        } catch (error) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    ऑफलाइन कंटेंट लोड करने में त्रुटि: ${error.message}
                </div>
            `;
        }
    }
}

// Global functions
window.downloadLecture = async function(lectureId) {
    const modal = new bootstrap.Modal(document.getElementById('downloadModal'));
    modal.show();
    
    // Mock download process
    const progressBar = document.getElementById('download-progress');
    const progressText = document.getElementById('download-percent');
    
    for (let i = 0; i <= 100; i += 10) {
        progressBar.style.width = i + '%';
        progressText.textContent = i + '%';
        await new Promise(resolve => setTimeout(resolve, 200));
    }
    
    modal.hide();
    
    // Simulate successful download
    setTimeout(() => {
        offlineSync.showNotification('लेक्चर सफलतापूर्वक डाउनलोड हो गया!', 'success');
        // Reload downloaded content
        offlinePage.loadDownloadedContent();
        offlinePage.updateStorageInfo();
    }, 500);
};

window.playOfflineLecture = function(lectureId) {
    offlineSync.playOfflineLecture(lectureId);
};

window.refreshAvailableContent = function() {
    offlinePage.loadAvailableContent();
};

window.cleanOldContent = async function() {
    if (confirm('30 दिन से पुराना कंटेंट डिलीट करना चाहते हैं?')) {
        await offlineSync.cleanOldLectures(30);
        offlineSync.showNotification('पुराना कंटेंट साफ़ कर दिया गया', 'success');
        offlinePage.loadDownloadedContent();
        offlinePage.updateStorageInfo();
    }
};

// Initialize page
const offlinePage = new OfflineLearningPage();
</script>

</body>
</html>