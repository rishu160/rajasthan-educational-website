<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - Student Test Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #f8f9fa; }
        .quiz-container { max-width: 800px; margin: 0 auto; }
        .question-card { border: 2px solid #007bff; border-radius: 10px; }
        .option-btn { margin: 5px 0; padding: 15px; text-align: left; }
        .cheat-warning { position: fixed; top: 0; left: 0; right: 0; z-index: 9999; }
        .progress-bar { height: 8px; }
    </style>
</head>
<body>
    <!-- Cheat Detection Warning -->
    <div id="cheatWarning" class="alert alert-danger cheat-warning" style="display: none;">
        <div class="container">
            <strong>⚠️ Warning:</strong> Tab switching detected! This activity has been logged.
        </div>
    </div>

    <div class="container mt-4 quiz-container">
        <!-- Quiz Header -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h4 id="quizTitle">Loading Quiz...</h4>
                        <small id="facultyInfo">Faculty: Loading...</small>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="badge bg-light text-dark fs-6" id="studentInfo">
                            Student: Loading...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress mb-4">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>

        <!-- Question Card -->
        <div class="card question-card" id="questionCard">
            <div class="card-header bg-light">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 id="questionNumber">Question 1 of 10</h5>
                    </div>
                    <div class="col-md-6 text-end">
                        <span class="badge bg-warning" id="tabSwitchCount">Tab Switches: 0</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <h5 id="questionText" class="mb-4">Loading question...</h5>
                <div id="optionsContainer">
                    <!-- Options will be loaded here -->
                </div>
                <div class="text-center mt-4">
                    <button class="btn btn-success btn-lg" id="nextBtn" onclick="nextQuestion()" disabled>
                        Next Question <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Quiz Complete Card -->
        <div class="card" id="completeCard" style="display: none;">
            <div class="card-header bg-success text-white text-center">
                <h4><i class="fas fa-check-circle"></i> Quiz Completed!</h4>
            </div>
            <div class="card-body text-center">
                <h5>Thank you for taking the quiz</h5>
                <p>Your responses have been submitted successfully.</p>
                <div id="finalScore" class="alert alert-info">
                    <strong>Your Score: <span id="scoreValue">0</span>/<span id="totalQuestions">0</span></strong>
                </div>
                <div id="cheatReport" class="alert alert-warning">
                    <strong>Tab Switches Detected: <span id="finalTabSwitches">0</span></strong>
                </div>
                <a href="check-quiz.html" class="btn btn-primary">Take Another Quiz</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let selectedAnswers = [];
        let tabSwitchCount = 0;
        let studentInfo = null;
        let quizStartTime = new Date();

        // Cheat Detection
        let isTabActive = true;
        
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                isTabActive = false;
                tabSwitchCount++;
                logCheatAttempt('Tab switched away from quiz');
                showCheatWarning();
                updateTabSwitchDisplay();
            } else {
                isTabActive = true;
            }
        });

        window.addEventListener('blur', function() {
            if (currentQuiz) {
                tabSwitchCount++;
                logCheatAttempt('Window lost focus');
                showCheatWarning();
                updateTabSwitchDisplay();
            }
        });

        // Prevent right-click and keyboard shortcuts
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && (e.key === 'c' || e.key === 'v' || e.key === 'a' || e.key === 's')) {
                e.preventDefault();
                logCheatAttempt('Attempted keyboard shortcut: Ctrl+' + e.key);
            }
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                e.preventDefault();
                logCheatAttempt('Attempted to open developer tools');
            }
        });

        function showCheatWarning() {
            const warning = document.getElementById('cheatWarning');
            warning.style.display = 'block';
            setTimeout(() => {
                warning.style.display = 'none';
            }, 3000);
        }

        function updateTabSwitchDisplay() {
            document.getElementById('tabSwitchCount').textContent = `Tab Switches: ${tabSwitchCount}`;
        }

        function logCheatAttempt(action) {
            const log = {
                studentName: studentInfo?.name || 'Unknown',
                rollNumber: studentInfo?.rollNumber || 'Unknown',
                action: action,
                timestamp: new Date().toISOString(),
                questionNumber: currentQuestionIndex + 1
            };

            // Add to quiz logs
            if (currentQuiz) {
                if (!currentQuiz.studentLogs) currentQuiz.studentLogs = [];
                currentQuiz.studentLogs.push(log);
                localStorage.setItem(currentQuiz.id, JSON.stringify(currentQuiz));
            }
        }

        function loadQuiz() {
            const urlParams = new URLSearchParams(window.location.search);
            const quizId = urlParams.get('id');
            
            if (!quizId) {
                alert('Invalid quiz link!');
                window.location.href = 'check-quiz.html';
                return;
            }

            currentQuiz = JSON.parse(localStorage.getItem(quizId));
            studentInfo = JSON.parse(sessionStorage.getItem('currentStudent'));

            if (!currentQuiz) {
                alert('Quiz not found!');
                window.location.href = 'check-quiz.html';
                return;
            }

            if (!studentInfo) {
                alert('Please enter your details first!');
                window.location.href = 'check-quiz.html';
                return;
            }

            // Initialize quiz
            document.getElementById('quizTitle').textContent = currentQuiz.subjectName;
            document.getElementById('facultyInfo').textContent = `Faculty: ${currentQuiz.facultyName}`;
            document.getElementById('studentInfo').textContent = `Student: ${studentInfo.name} (${studentInfo.rollNumber})`;
            
            selectedAnswers = new Array(currentQuiz.questions.length).fill(null);
            showQuestion();
        }

        function showQuestion() {
            const question = currentQuiz.questions[currentQuestionIndex];
            const totalQuestions = currentQuiz.questions.length;
            
            document.getElementById('questionNumber').textContent = `Question ${currentQuestionIndex + 1} of ${totalQuestions}`;
            document.getElementById('questionText').textContent = question.text;
            
            // Update progress
            const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            // Show options
            const container = document.getElementById('optionsContainer');
            container.innerHTML = Object.entries(question.options).map(([key, value]) => `
                <button class="btn btn-outline-primary btn-lg w-100 option-btn" onclick="selectOption('${key}')">
                    ${key}) ${value}
                </button>
            `).join('');
            
            document.getElementById('nextBtn').disabled = true;
        }

        function selectOption(option) {
            selectedAnswers[currentQuestionIndex] = option;
            
            // Update button styles
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            });
            
            event.target.classList.remove('btn-outline-primary');
            event.target.classList.add('btn-primary');
            
            document.getElementById('nextBtn').disabled = false;
        }

        function nextQuestion() {
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= currentQuiz.questions.length) {
                completeQuiz();
            } else {
                showQuestion();
            }
        }

        function completeQuiz() {
            // Calculate score
            let score = 0;
            currentQuiz.questions.forEach((question, index) => {
                if (selectedAnswers[index] === question.correct) {
                    score++;
                }
            });

            // Log completion
            logCheatAttempt(`Quiz completed with score: ${score}/${currentQuiz.questions.length}`);

            // Show results
            document.getElementById('questionCard').style.display = 'none';
            document.getElementById('completeCard').style.display = 'block';
            document.getElementById('scoreValue').textContent = score;
            document.getElementById('totalQuestions').textContent = currentQuiz.questions.length;
            document.getElementById('finalTabSwitches').textContent = tabSwitchCount;

            // Save final results
            const result = {
                studentName: studentInfo.name,
                rollNumber: studentInfo.rollNumber,
                score: score,
                totalQuestions: currentQuiz.questions.length,
                tabSwitches: tabSwitchCount,
                completedAt: new Date().toISOString(),
                timeTaken: Math.round((new Date() - quizStartTime) / 1000) + ' seconds'
            };

            if (!currentQuiz.results) currentQuiz.results = [];
            currentQuiz.results.push(result);
            localStorage.setItem(currentQuiz.id, JSON.stringify(currentQuiz));
        }

        // Load quiz on page load
        loadQuiz();
    </script>
</body>
</html>